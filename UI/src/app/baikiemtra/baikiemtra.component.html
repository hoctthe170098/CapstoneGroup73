<div class="testlist-container">
  <h2>DANH S√ÅCH B√ÄI KI·ªÇM TRA</h2>
  <div class="card">
    <div class="filters">
      <div class="filters-left">
        <select [(ngModel)]="selectedStatus" (change)="loadTests()">
          <option [value]="'all'">Tr·∫°ng th√°i</option>
          <option *ngFor="let status of statusList" [value]="status">{{ status }}</option>
        </select>

        <!-- DROPDOWN L·ªöP TRONG FILTER -->
        <div class="lop-select-container filter-mode">
          <div class="lop-select-display" (click)="toggleClassDropdown()">
            <span *ngIf="selectedClass === 'all'">Ch·ªçn l·ªõp</span>
            <span *ngIf="selectedClass !== 'all'">{{ selectedClass }}</span>
            <i class="fa fa-caret-down caret-icon"></i>
          </div>

          <div class="lop-select-dropdown" *ngIf="classDropdownOpen">
            <div class="search-box">
              <input type="text" placeholder="T√¨m l·ªõp" [(ngModel)]="classSearchTerm"
                (input)="onClassSearchTermChange()" />
            </div>
            <ul class="select-options">
              <li (click)="selectClassFilter('all')">T·∫•t c·∫£</li>
              <li *ngFor="let option of filteredClassListForFilter" (click)="selectClassFilter(option)">
                {{ option }}
              </li>
              <li *ngIf="filteredClassListForFilter.length === 0" class="no-result">Kh√¥ng t√¨m th·∫•y l·ªõp</li>
            </ul>
          </div>
        </div>


        <input type="text" placeholder="T√¨m t√™n b√†i ki·ªÉm tra..." [(ngModel)]="searchText" (ngModelChange)="onSearchTextChanged()" />

      </div>

      <button class="add-button" (click)="openModal()">+ Th√™m</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>T√™n</th>
          <th>L·ªõp</th>
          <th>Ng√†y T·∫°o</th>
          <th>Ng√†y Ki·ªÉm Tra</th>
          <th>T√†i Li·ªáu</th>
          <th>Tr·∫°ng th√°i</th>
          <th>ƒêi·ªÉm</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let test of paginatedList">
          <td>{{ test.ten }}</td>
          <td>{{ test.tenLop }}</td>
          <td>{{ test.ngayTao | date: 'dd/MM/yyyy' }}</td>
          <td>{{ test.ngayKiemTra | date: 'dd/MM/yyyy' }}</td>
          <td>
            <a href="javascript:void(0)" (click)="downloadFile(test.urlFile, test.urlFile.split('/').pop())">
              <i class="fa fa-download"></i> Download
            </a>
          </td>
          <td>
            <span [class.checked]="test.trangThai === 'ƒê√£ ki·ªÉm tra'">{{ test.trangThai }}</span></td>
            <td>
              <a *ngIf="test.coDiem" class="download" (click)="exportKetquabaikiemtra(test.id)">
                Download
              </a>
              <span *ngIf="!test.coDiem" class="pending">
                Ch∆∞a v√†o ƒëi·ªÉm
              </span>
            </td>
            
          <td>
            <button class="edit-btn ft-edit-2" (click)="openEditModal(test)"></button>
            <button class="delete-btn ft-trash-2" (click)="confirmAndDelete(test)"></button>
          </td>
        </tr>
      </tbody>

    </table>

    <div class="pagination-container" *ngIf="totalPages.length > 1">
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="changePage(currentPage - 1)">¬´</a>
        </li>
        <li *ngFor="let page of totalPages" class="page-item" [class.active]="currentPage === page">
          <a class="page-link" (click)="changePage(page)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages.length">
          <a class="page-link" (click)="changePage(currentPage + 1)">¬ª</a>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- T·∫†O B√ÄI KI·ªÇM TRA MODAL -->
<div class="my-modal-overlay" *ngIf="showCreateForm">
  <div class="my-modal">
    <div class="my-modal-header">
      <h3>T·∫†O B√ÄI KI·ªÇM TRA</h3>
      <button class="close-btn ft-x" (click)="closeModal()"></button>
    </div>

    <div class="my-modal-body">
      <!-- T√äN -->
      <div class="form-group">
        <label for="tenBaiKiemTra">T√™n B√†i Ki·ªÉm Tra</label>
        <input id="tenBaiKiemTra" name="tenBaiKiemTra" type="text" class="form-control" required minlength="5"
          [(ngModel)]="newTest.tenBaiKiemTra" #tenBaiKiemTra="ngModel" />
        <small class="text-danger" *ngIf="tenBaiKiemTra.errors?.required && tenBaiKiemTra.touched">
          T√™n b√†i ki·ªÉm tra kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!
        </small>
        <small class="text-danger" *ngIf="newTest.tenBaiKiemTra.length > 50">
          T√™n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±!
        </small>
        <small class="text-danger" *ngIf="tenBaiKiemTra.errors?.minlength && tenBaiKiemTra.touched">
          T√™n ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±!
        </small>
      </div>

      <!-- NG√ÄY + L·ªöP -->
      <div class="flex-row">
        <div class="form-group">
          <label>Ng√†y Ki·ªÉm Tra</label>
          <input type="date" [(ngModel)]="newTest.ngayKiemTra" />
        </div>

        <!-- Dropdown L·ªõp t√πy ch·ªânh -->
        <div class="form-group lop-select-container">
          <label>L·ªõp</label>
          <div class="lop-select-display" (click)="toggleLopDropdown()">
            <span *ngIf="!newTest.tenLop">Ch·ªçn l·ªõp</span>
            <span *ngIf="newTest.tenLop">{{ newTest.tenLop }}</span>
            <i class="fa fa-caret-down caret-icon"></i>
          </div>

          <!-- Dropdown n·ªôi dung -->
          <div class="lop-select-dropdown" *ngIf="lopDropdownOpen">
            <div class="search-box">
              <input type="text" placeholder="T√¨m l·ªõp" [(ngModel)]="lopSearchTerm" (input)="onLopSearchTermChange()" />
            </div>

            <ul class="select-options">
              <li *ngFor="let option of filteredClassList" (click)="selectLop(option)">
                {{ option }}
              </li>
              <li *ngIf="filteredClassList.length === 0" class="no-result">
                Kh√¥ng t√¨m th·∫•y l·ªõp
              </li>
            </ul>
          </div>
        </div>
      </div>


      <!-- L·ªäCH L·ªöP -->
      <div class="form-group">
        <label>L·ªãch c·ªßa l·ªõp</label>
        <ul class="class-schedule">
          <li *ngIf="selectedClassSchedule.length === 0">Kh√¥ng c√≥ l·ªãch</li>
          <li *ngFor="let lich of selectedClassSchedule">
            {{ getThuText(lich.thu) }} ‚Äì {{ lich.tenPhong }}<br />
            <small>
              T·ª´ {{ lich.ngayBatDau | date: 'dd/MM/yyyy' }} ƒë·∫øn {{ lich.ngayKetThuc | date: 'dd/MM/yyyy' }}
            </small>
          </li>
        </ul>
      </div>

      <!-- T√ÄI LI·ªÜU -->
      <div class="form-group">
        <label>T√†i li·ªáu</label>
        <div class="upload-box">
          <p>üìÇ Ch·ªçn ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
          <input type="file" (change)="onFileSelected($event)" />
        </div>
      </div>
    </div> <!-- ƒê√ìNG BODY ·ªû ƒê√ÇY -->

    <div class="my-modal-footer">
      <button class="submit-btn" (click)="addTest()">TH√äM</button>
    </div>
  </div>
</div>
<!-- S·ª¨A B√ÄI KI·ªÇM TRA MODAL -->
<div class="my-modal-overlay" *ngIf="showEditForm">
  <div class="my-modal">
    <div class="my-modal-header">
      <h3>S·ª¨A B√ÄI KI·ªÇM TRA</h3>
      <button class="close-btn ft-x" (click)="closeEditModal()"></button>
    </div>

    <div class="my-modal-body">
      <!-- T√äN B√ÄI KI·ªÇM TRA -->
      <div class="form-group">
        <label>T√™n B√†i Ki·ªÉm Tra</label>
        <input type="text" required minlength="5" [(ngModel)]="editTest.tenBaiKiemTra" #editTenBaiKiemTra="ngModel"
          placeholder="Nh·∫≠p t√™n b√†i ki·ªÉm tra..." />
        <small class="text-danger" *ngIf="editTenBaiKiemTra.errors?.required && editTenBaiKiemTra.touched">
          T√™n b√†i ki·ªÉm tra kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!
        </small>
        <small class="text-danger" *ngIf="editTest.tenBaiKiemTra.length > 50">
          T√™n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±!
        </small>
        <small class="text-danger" *ngIf="editTenBaiKiemTra.errors?.minlength && editTenBaiKiemTra.touched">
          T√™n ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±!
        </small>
      </div>

      <!-- NG√ÄY KI·ªÇM TRA + L·ªöP -->
      <div class="flex-row">
        <div class="form-group">
          <label>Ng√†y Ki·ªÉm Tra</label>
          <input type="date" [(ngModel)]="editTest.ngayKiemTra" />
        </div>
        <div class="form-group">
          <label>L·ªõp</label>
          <input
            type="text"
            class="form-control"
            [value]="editTest.tenLop"
            readonly
          />
        </div>
        
      </div>

      <!-- L·ªäCH L·ªöP -->
      <div class="form-group">
        <label>L·ªãch c·ªßa l·ªõp</label>
        <ul class="class-schedule">
          <li *ngIf="selectedClassSchedule.length === 0">Kh√¥ng c√≥ l·ªãch</li>
          <li *ngFor="let lich of selectedClassSchedule">
            {{ getThuText(lich.thu) }} ‚Äì {{ lich.tenPhong }}<br />
            <small>
              T·ª´ {{ lich.ngayBatDau | date: 'dd/MM/yyyy' }} ƒë·∫øn {{ lich.ngayKetThuc | date: 'dd/MM/yyyy' }}
            </small>
          </li>
        </ul>
      </div>

      <!-- T√ÄI LI·ªÜU HI·ªÜN T·∫†I + CH·ªåN FILE M·ªöI -->
      <div class="form-group">
        <label><strong>T√†i li·ªáu</strong></label>

        <!-- N·∫øu c√≥ file -->
        <div class="file-preview" *ngIf="editTest.document">
          <div class="file-info">
            <div class="file-icon">
              <img src="assets/icons/pdf-icon.svg" alt="PDF" />
            </div>
            <div class="file-details">
              <div class="file-name">{{ editTest.document.name }}</div>
            </div>
          </div>
          <div class="file-actions">
            <a [href]="editTest.document.url" download title="T·∫£i xu·ªëng">
              <i class="fa fa-download"></i>
            </a>
            <button class="delete-icon" (click)="removeDocument()" title="Xo√°">
              <i class="fa fa-trash text-danger"></i>
            </button>
          </div>
        </div>

        <!-- N·∫øu ch∆∞a c√≥ file ho·∫∑c ƒë√£ xo√° -->
        <div class="upload-box" *ngIf="!editTest.document">
          <p>üìÇ K√©o th·∫£ ho·∫∑c ch·ªçn file</p>
          <input type="file" (change)="onFileSelected($event, 'edit')" />
        </div>
      </div>
    </div>

    <div class="my-modal-footer">
      <button class="submit-btn" (click)="updateTest()">L∆ØU</button>
    </div>
  </div>
</div>