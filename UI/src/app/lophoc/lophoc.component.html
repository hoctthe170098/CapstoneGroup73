<div class="lop-hoc-wrapper">
  <!-- Tiêu đề + nút Thêm lớp học -->
  <div class="top-bar">
    <h2 class="page-title">DANH SÁCH LỚP HỌC</h2>
    <button class="btn add-class-btn" (click)="onAddClass()">
      Thêm lớp học
    </button>
  </div>

  <div class="content-row">
    <!-- Cột trái: Filter -->
    <div class="left-filter">
      <!-- Tìm kiếm -->
      <label for="searchClass">Tìm Kiếm</label>
      <input
        id="searchClass"
        type="text"
        class="form-control"
        placeholder="Tên lớp học..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="onFilterChange()"
      />

      <!-- Thứ Trong Tuần -->
      <h4>Thứ Trong Tuần</h4>
      <div class="checkbox-group">
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu2"
            (change)="onFilterChange()"
          />
          Thứ 2</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu3"
            (change)="onFilterChange()"
          />
          Thứ 3</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu4"
            (change)="onFilterChange()"
          />
          Thứ 4</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu5"
            (change)="onFilterChange()"
          />
          Thứ 5</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu6"
            (change)="onFilterChange()"
          />
          Thứ 6</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.thu7"
            (change)="onFilterChange()"
          />
          Thứ 7</label
        >
        <label
          ><input
            type="checkbox"
            [(ngModel)]="thuTrongTuan.cn"
            (change)="onFilterChange()"
          />
          Chủ Nhật</label
        >
      </div>

      <!-- Chương Trình -->
      <label for="chuongTrinhSelect">Chương Trình</label>
      <select
        id="chuongTrinhSelect"
        class="form-control"
        [(ngModel)]="chuongTrinhId"
        (change)="onFilterChange()"
      >
        <option [value]="0">Tất cả chương trình</option>
        <option *ngFor="let item of chuongTrinhOptions" [value]="item.id">
          {{ item.tieuDe }}
        </option>
      </select>

      <!-- Trạng Thái -->
      <label for="trangThaiSelect">Trạng Thái</label>
      <select
        id="trangThaiSelect"
        class="form-control"
        [(ngModel)]="trangThai"
        (change)="onFilterChange()"
      >
        <option value="">Chọn trạng thái</option>
        <option value="Cố định">Cố định</option>
        <option value="Dạy thay">Dạy thay</option>
        <option value="Dạy bù">Dạy bù</option>
      </select>

      <label for="giaoVienFilter">Giáo Viên</label>
      <div class="custom-select-wrapper" (click)="toggleGiaoVienDropdown()">
        <input
          type="text"
          class="custom-select-input"
          placeholder="Chọn giáo viên"
          [value]="getSelectedGiaoVienText()"
          readonly
        />
        <span
          class="clear-icon ft-x-circle"
          *ngIf="selectedGiaoVien"
          (click)="clearGiaoVienSelection($event)"
        ></span>
        <span class="custom-select-arrow"><i class="ft-chevron-down"></i></span>

        <div
          class="custom-select-dropdown"
          *ngIf="isGiaoVienDropdownOpen"
          (click)="$event.stopPropagation()"
        >
          <div class="custom-select-search">
            <input
              type="text"
              class="form-control"
              placeholder="Tìm giáo viên"
              [(ngModel)]="giaoVienSearch"
              (input)="onGiaoVienSearch()"
            />
          </div>
          <ul class="custom-select-options">
            <li
              *ngFor="let gv of filteredGiaoVienOptions"
              (click)="selectGiaoVien(gv); $event.stopPropagation()"
            >
              {{ gv.codeTen }}
            </li>
            <li *ngIf="filteredGiaoVienOptions.length === 0" class="no-result">
              Không tìm thấy
            </li>
          </ul>
        </div>
      </div>
      <!-- Thời gian -->
      <label>Thời gian</label>
      <div class="time-range">
        <div class="time-box">
          <label>Bắt đầu</label>
          <input
            type="time"
            class="form-control"
            [(ngModel)]="timeStart"
            (change)="onFilterChange()"
          />
        </div>
        <div class="time-box">
          <label>Kết thúc</label>
          <input
            type="time"
            class="form-control"
            [(ngModel)]="timeEnd"
            (change)="onFilterChange()"
          />
        </div>
      </div>

      <!-- Ngày -->
      <label>Ngày</label>
      <div class="date-range">
        <div class="date-box">
          <label>Bắt đầu</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="dateStart"
            (change)="onFilterChange()"
          />
        </div>
        <div class="date-box">
          <label>Kết thúc</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="dateEnd"
            (change)="onFilterChange()"
          />
        </div>
      </div>
    </div>

    <!-- Cột phải: Danh sách lớp -->
    <div class="right-list">
      <div *ngIf="lophocs.length === 0" class="no-class-message">
        Hiện không có lớp học nào !
      </div>
      <div class="lop-hoc-item" *ngFor="let lop of lophocs; let i = index">
        <div class="lop-hoc-title-bar">
          {{ lop.tenLop }}
        </div>

        <div class="lop-hoc-body">
          <div class="lop-hoc-subheader">
            <div class="lop-hoc-chuongtrinh">
              <strong>Chương trình:</strong> {{ lop.chuongTrinh }}<br />
              <strong>Phòng:</strong> {{ lop.phong }}
            </div>
            <div class="lop-hoc-giaovien">
              <strong>Giáo viên:</strong> {{ lop.giaoVien }}
            </div>
          </div>

          <div class="lop-hoc-info">
            <p><strong>Lịch học:</strong></p>
            <ul class="lich-hoc-list">
              <li *ngFor="let item of lop.lichHocChiTiet">
                {{ getThuHienThi(item.thu) }}: {{ item.gioBatDau }} -
                {{ item.gioKetThuc }} - <u>{{ item.tenPhong }}</u>
              </li>
            </ul>
            <p>
              <strong>Ngày bắt đầu:</strong>
              {{ lop.ngayBatDau | date : "dd/MM/yyyy" }}
            </p>
            <p>
              <strong>Ngày kết thúc:</strong>
              {{ lop.ngayKetThuc | date : "dd/MM/yyyy" }}
            </p>
            <!-- Nút + và menu ẩn/hiện -->
            <div
              class="action-plus-wrapper"
              (click)="toggleActionMenu(i, $event)"
            >
              <i class="ft-plus-circle action-plus-icon"></i>

              <div
                *ngIf="lop.showActionMenu"
                class="action-menu"
                (click)="$event.stopPropagation()"
              >
                <div
                  class="action-option"
                  (click)="openAddScheduleModal(lop, 'Dạy thay')"
                >
                  Dạy thay
                </div>
                <div
                  class="action-option"
                  (click)="openAddScheduleModal(lop, 'Dạy bù')"
                >
                  Dạy bù
                </div>
              </div>
            </div>

            <p>
              <strong>Học phí:</strong>
              {{ lop.hocPhi | number : "1.0-0" }} VND/buổi
            </p>
            <p><strong>Trạng thái:</strong> {{ lop.trangThai }}</p>
          </div>

          <div class="lop-hoc-footer">
            <button class="btn edit-btn" (click)="onEditClass(i)">Sửa</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP Thêm Lịch Mới -->
  <div class="modal-container" *ngIf="isAddScheduleModalOpen">
    <div class="modal-overlay" (click)="closeAddScheduleModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>THÊM LỊCH {{ newSchedule.loaiLich.toUpperCase() }}</h3>
        <button class="close-btn" (click)="closeAddScheduleModal()">
          <i class="ft-x"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Ngày -->
        <label>Ngày</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="newSchedule.ngay"
        />

        <div *ngIf="newSchedule.loaiLich === 'Dạy thay'">
          <label>Giáo viên</label>
          <div
            class="custom-select-wrapper"
            (click)="togglePopupGiaoVienDropdown($event)"
          >
            <input
              type="text"
              class="custom-select-input"
              placeholder="Chọn giáo viên"
              [value]="getSelectedPopupGiaoVienText()"
              readonly
            />
            <span class="custom-select-arrow"
              ><i class="ft-chevron-down"></i
            ></span>

            <div
              class="custom-select-dropdown"
              *ngIf="isPopupGiaoVienDropdownOpen"
              (click)="$event.stopPropagation()"
            >
              <div class="custom-select-search">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Tìm giáo viên"
                  [(ngModel)]="popupGiaoVienSearch"
                  (input)="onPopupGiaoVienSearch()"
                />
              </div>
              <ul class="custom-select-options">
                <li
                  *ngFor="let gv of popupFilteredGiaoVienOptions"
                  (click)="selectPopupGiaoVien(gv); $event.stopPropagation()"
                >
                  {{ gv.codeTen }}
                </li>
                <li
                  *ngIf="popupFilteredGiaoVienOptions.length === 0"
                  class="no-result"
                >
                  Không tìm thấy
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Phòng -->
        <label>Phòng</label>
        <select class="form-control" [(ngModel)]="newSchedule.phong">
          <option *ngFor="let phong of phongOptions" [value]="phong.id">
            {{ phong.ten }}
          </option>
        </select>

        <!-- Thời gian -->
        <div class="form-row">
          <div class="form-group">
            <label>Thời gian bắt đầu</label>
            <input
              type="time"
              class="form-control"
              [(ngModel)]="newSchedule.batDau"
            />
          </div>
          <div class="form-group">
            <label>Thời gian kết thúc</label>
            <input
              type="time"
              class="form-control"
              [(ngModel)]="newSchedule.ketThuc"
            />
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn save-btn" (click)="submitNewSchedule()">THÊM</button>
      </div>
    </div>
  </div>

  <!-- Phân trang -->
  <div class="pagination-container" *ngIf="totalPages > 1">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="goToPage(currentPage - 1)">«</a>
      </li>

      <li
        class="page-item"
        *ngFor="let page of [].constructor(totalPages); let idx = index"
        [class.active]="currentPage === idx + 1"
      >
        <a class="page-link" (click)="goToPage(idx + 1)">{{ idx + 1 }}</a>
      </li>

      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="goToPage(currentPage + 1)">»</a>
      </li>
    </ul>
  </div>
</div>
